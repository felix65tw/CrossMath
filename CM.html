<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CrossMath Puzzle</title>
    <style>
        :root {
            --bg-main: #f8f9fa;
            --primary: #3b82f6;
            --cell-num: #ffffff;
            --cell-op: #e5e7eb;
            --cell-res: #4b5563;
            --text-dark: #1f2937;
            --accent: #10b981;
            --error: #ef4444;
            /* ç²¾æº–è¨ˆç®—æ ¼å­ï¼Œç¢ºä¿ 7x7 åœ¨å°è¢å¹•ä¸æº¢å‡º */
            --grid-gap: 4px;
            --cell-size: min(12vw, 5.8vh);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-dark);
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* é ‚éƒ¨å°è¦½åˆ— */
        .nav {
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .nav h1 { font-size: 1.2rem; margin: 0; font-weight: 800; color: var(--primary); }
        .nav .score { 
            font-size: 0.9rem; 
            font-weight: 600; 
            color: #6b7280;
            display: flex;
            gap: 15px;
        }
        .nav .score span {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .nav .score .hint-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 5px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .nav .score .hint-btn:active {
            transform: translateY(1px);
            background: #2563eb;
        }
        .nav .score .hint-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* éŠæˆ²å€åŸŸ */
        .game-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(7, var(--cell-size));
            grid-template-rows: repeat(7, var(--cell-size));
            gap: var(--grid-gap);
            background: #d1d5db;
            padding: var(--grid-gap);
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .cell {
            background: var(--cell-num);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            font-weight: 700;
            transition: all 0.15s ease;
        }

        /* æ•¸å­—è¼¸å…¥æ ¼ */
        .cell.input {
            color: var(--primary);
            cursor: pointer;
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.05);
        }
        .cell.input.selected {
            background: var(--primary);
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
            z-index: 2;
        }

        /* å›ºå®šæ•¸å­—æ ¼ */
        .cell.fixed { background: #f3f4f6; color: var(--text-dark); }

        /* é‹ç®—ç¬¦èˆ‡ç­‰è™Ÿ */
        .cell.op, .cell.eq {
            background: var(--cell-op);
            color: #6b7280;
            font-size: 1rem;
        }

        /* çµæœæ ¼ */
        .cell.res {
            background: var(--cell-res);
            color: #fff;
        }

        .cell.empty { background: transparent; }

        /* ç‹€æ…‹é¡è‰² */
        .cell.correct { background: var(--accent) !important; color: white !important; }
        .cell.wrong { background: var(--error) !important; color: white !important; animation: shake 0.4s; }
        .cell.hint { background: #fbbf24 !important; color: white !important; }

        /* éµç›¤å€åŸŸ */
        .keyboard {
            background: #fff;
            padding: 15px 10px calc(15px + env(safe-area-inset-bottom));
            border-radius: 24px 24px 0 0;
            box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
        }

        .keys-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            max-width: 500px;
            margin: 0 auto;
        }

        .key {
            background: #f3f4f6;
            border: none;
            padding: 15px 0;
            border-radius: 12px;
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-dark);
            cursor: pointer;
            transition: active 0.1s;
        }

        .key:active { background: #e5e7eb; transform: translateY(2px); }
        .key.action { background: var(--primary); color: #fff; grid-column: span 2; font-size: 1rem; }
        .key.del { background: #fee2e2; color: #ef4444; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            60% { transform: translateX(5px); }
        }
        
        /* éš±è—å½©è›‹æç¤º */
        .easter-egg-notification {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.9rem;
            z-index: 1000;
            animation: fadeOut 3s forwards;
        }
        
        @keyframes fadeOut {
            0% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; display: none; }
        }
    </style>
</head>
<body>

<div class="nav">
    <h1>CrossMath</h1>
    <div class="score">
        <span id="timerClickArea">â±ï¸ <span id="timer">00:00</span></span>
        <span>ğŸ† Score: <span id="score">0</span></span>
        <button class="hint-btn" id="hintBtn" onclick="useHint()">ğŸ’¡ Hint (3 left)</button>
        <span onclick="location.reload()">ğŸ”„ Restart</span>
    </div>
</div>

<div class="game-area">
    <div class="grid" id="gameGrid"></div>
</div>

<div class="keyboard">
    <div class="keys-grid">
        <button class="key" onclick="press(1)">1</button>
        <button class="key" onclick="press(2)">2</button>
        <button class="key" onclick="press(3)">3</button>
        <button class="key" onclick="press(4)">4</button>
        <button class="key" onclick="press(5)">5</button>
        <button class="key" onclick="press(6)">6</button>
        <button class="key" onclick="press(7)">7</button>
        <button class="key" onclick="press(8)">8</button>
        <button class="key" onclick="press(9)">9</button>
        <button class="key" onclick="press(0)">0</button>
        <button class="key del" onclick="press('del')">âŒ«</button>
        <button class="key action" onclick="checkAll()">Check Answer</button>
        <button class="key action" style="background:#6b7280" onclick="generate()">Next Puzzle</button>
    </div>
</div>

<script>
    let gridData = [];
    let activeIdx = -1;
    let score = 0;
    let hintsRemaining = 3;
    let startTime = null;
    let timerInterval = null;
    let totalCorrect = 0;
    let totalInputCells = 0;
    let unlimitedHints = false;
    let timerClickCount = 0;
    let timerClickTimeout = null;

    // åˆå§‹åŒ–è¨ˆæ™‚å™¨
    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        startTime = new Date();
        timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        const now = new Date();
        const diff = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
        const seconds = (diff % 60).toString().padStart(2, '0');
        document.getElementById('timer').textContent = `${minutes}:${seconds}`;
    }

    function updateScore() {
        document.getElementById('score').textContent = score;
    }

    function updateHintButton() {
        const btn = document.getElementById('hintBtn');
        if (unlimitedHints) {
            btn.textContent = `ğŸ’¡ Hint (âˆ unlimited)`;
            btn.disabled = false;
            btn.style.background = '#10b981';
        } else {
            btn.textContent = `ğŸ’¡ Hint (${hintsRemaining} left)`;
            btn.disabled = hintsRemaining <= 0;
            btn.style.background = hintsRemaining <= 0 ? '#9ca3af' : 'var(--primary)';
        }
    }

    // è™•ç†æ™‚é–“æ–¹æ¡†é»æ“Šäº‹ä»¶
    function setupTimerClickHandler() {
        const timerClickArea = document.getElementById('timerClickArea');
        timerClickArea.style.cursor = 'pointer';
        timerClickArea.title = "Click me 3 times for a surprise!";
        
        timerClickArea.addEventListener('click', function() {
            timerClickCount++;
            
            // æ¸…é™¤ä¹‹å‰çš„è¶…æ™‚
            if (timerClickTimeout) {
                clearTimeout(timerClickTimeout);
            }
            
            // è¨­ç½®è¶…æ™‚é‡ç½®è¨ˆæ•¸
            timerClickTimeout = setTimeout(() => {
                timerClickCount = 0;
            }, 2000); // 2ç§’å…§éœ€è¦é»æ“Š3æ¬¡
            
            // æª¢æŸ¥æ˜¯å¦é”åˆ°3æ¬¡é»æ“Š
            if (timerClickCount === 3) {
                activateUnlimitedHints();
                timerClickCount = 0;
            }
        });
    }
    
    // å•Ÿç”¨ç„¡é™æç¤º
    function activateUnlimitedHints() {
        unlimitedHints = true;
        hintsRemaining = 999; // è¨­å®šä¸€å€‹å¾ˆå¤§çš„æ•¸å­—
        updateHintButton();
        
        // é¡¯ç¤ºå½©è›‹é€šçŸ¥
        showEasterEggNotification("ğŸ‰ Unlimited hints activated! ğŸ‰");
        
        // æ’­æ”¾éŸ³æ•ˆï¼ˆå¦‚æœéœ€è¦çš„è©±ï¼‰
        // playEasterEggSound();
    }
    
    // é¡¯ç¤ºå½©è›‹é€šçŸ¥
    function showEasterEggNotification(message) {
        // ç§»é™¤ç¾æœ‰çš„é€šçŸ¥
        const existingNotification = document.querySelector('.easter-egg-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        const notification = document.createElement('div');
        notification.className = 'easter-egg-notification';
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // 3ç§’å¾Œè‡ªå‹•ç§»é™¤
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }

    // æ”¯æ´å…ˆä¹˜é™¤å¾ŒåŠ æ¸›çš„é‚è¼¯
    function solve(a, op1, b, op2, c) {
        let items = [a, b, c];
        let ops = [op1, op2];
        // ä¹˜é™¤å„ªå…ˆ
        for (let i = 0; i < 2; i++) {
            if (ops[i] === '*' || ops[i] === '/') {
                if (ops[i] === '/' && (items[i+1] === 0 || items[i] % items[i+1] !== 0)) return null;
                let res = ops[i] === '*' ? items[i] * items[i+1] : items[i] / items[i+1];
                items.splice(i, 2, res);
                ops.splice(i, 1);
                i--;
            }
        }
        // åŠ æ¸›
        let final = items[0];
        if (ops.length > 0) {
            final = ops[0] === '+' ? items[0] + items[1] : items[0] - items[1];
        }
        return final;
    }

    function generate() {
        const grid = document.getElementById('gameGrid');
        grid.innerHTML = '';
        gridData = Array(49).fill({type: 'empty'});
        totalCorrect = 0;
        totalInputCells = 0;
        
        let attempts = 0;
        while (attempts < 2000) {
            attempts++;
            let temp = {};
            // éš¨æ©Ÿå¡«å…¥æ•¸å­— (1-15 è¼ƒå¥½è¨ˆç®—)
            [0,2,4,14,16,18,28,30,32].forEach(i => temp[i] = Math.floor(Math.random()*13)+1);
            // éš¨æ©Ÿå¡«å…¥é‹ç®—ç¬¦
            [1,3,15,17,29,31,7,21,9,23,11,25].forEach(i => temp[i] = ['+','-','*','/'][Math.floor(Math.random()*4)]);

            // é©—è­‰æ©«å‘
            let r0 = solve(temp[0], temp[1], temp[2], temp[3], temp[4]);
            let r2 = solve(temp[14], temp[15], temp[16], temp[17], temp[18]);
            let r4 = solve(temp[28], temp[29], temp[30], temp[31], temp[32]);
            
            // é©—è­‰ç¸±å‘
            let c0 = solve(temp[0], temp[7], temp[14], temp[21], temp[28]);
            let c2 = solve(temp[2], temp[9], temp[16], temp[23], temp[30]);
            let c4 = solve(temp[4], temp[11], temp[18], temp[25], temp[32]);

            let all = [r0, r2, r4, c0, c2, c4];
            if (all.every(v => v !== null && v >= 0 && v < 100)) {
                // æˆåŠŸç”Ÿæˆ
                const numIdx = [0,2,4,14,16,18,28,30,32];
                numIdx.forEach(idx => {
                    let isHide = Math.random() > 0.4;
                    gridData[idx] = { 
                        type: isHide?'input':'fixed', 
                        val: temp[idx], 
                        user: '',
                        correct: false,
                        hinted: false
                    };
                    if (isHide) totalInputCells++;
                });
                [1,3,15,17,29,31,7,21,9,23,11,25].forEach(idx => gridData[idx] = { type: 'op', val: temp[idx] });
                [5,19,33,35,37,39].forEach(idx => gridData[idx] = { type: 'eq', val: '=' });
                [6,20,34].forEach((idx, i) => gridData[idx] = { type: 'res', val: [r0, r2, r4][i] });
                [42,44,46].forEach((idx, i) => gridData[idx] = { type: 'res', val: [c0, c2, c4][i] });
                break;
            }
        }
        startTimer();
        render();
    }

    function render() {
        const container = document.getElementById('gameGrid');
        container.innerHTML = '';
        gridData.forEach((d, i) => {
            let el = document.createElement('div');
            el.className = `cell ${d.type}`;
            
            // æ·»åŠ æç¤ºæ¨£å¼
            if (d.hinted) {
                el.classList.add('hint');
            }
            
            if (d.type === 'input') {
                el.innerText = d.user;
                el.onclick = () => {
                    document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
                    el.classList.add('selected');
                    activeIdx = i;
                };
            } else if (d.type !== 'empty') {
                el.innerText = d.val === '*' ? 'Ã—' : d.val === '/' ? 'Ã·' : d.val;
            }
            container.appendChild(el);
        });
    }

    function press(v) {
        if (activeIdx === -1) return;
        let cell = gridData[activeIdx];
        if (v === 'del') {
            cell.user = '';
            // å¦‚æœä¹‹å‰æ˜¯æ­£ç¢ºçš„ï¼Œç¾åœ¨åˆªé™¤å¾Œå°±ä¸æ­£ç¢ºäº†
            if (cell.correct) {
                cell.correct = false;
                totalCorrect--;
                score = Math.max(0, score - 10); // æ‰£å›åˆ†æ•¸
                updateScore();
            }
        } else if (cell.user.length < 2) {
            cell.user += v;
            // æª¢æŸ¥æ˜¯å¦æ­£ç¢º
            if (parseInt(cell.user) === cell.val && !cell.correct) {
                cell.correct = true;
                totalCorrect++;
                score += 10;
                updateScore();
            } else if (parseInt(cell.user) !== cell.val && cell.correct) {
                cell.correct = false;
                totalCorrect--;
                score = Math.max(0, score - 10);
                updateScore();
            }
        }
        render();
        // è‡ªå‹•é‡æ–°é¸ä¸­
        const inputCells = gridData.filter((d,idx) => d.type==='input' && idx<=activeIdx);
        if (inputCells.length > 0) {
            const index = inputCells.length - 1;
            document.querySelectorAll('.cell.input')[index].click();
        }
    }

    function useHint() {
        // æª¢æŸ¥æ˜¯å¦æœ‰ç„¡é™æç¤º
        if (!unlimitedHints && hintsRemaining <= 0) return;
        
        // æ‰¾å‡ºæœªå¡«å¯«æ­£ç¢ºçš„è¼¸å…¥æ ¼å­
        const emptyCells = gridData
            .map((cell, idx) => ({cell, idx}))
            .filter(item => item.cell.type === 'input' && !item.cell.correct && !item.cell.hinted);
        
        if (emptyCells.length === 0) return;
        
        // éš¨æ©Ÿé¸æ“‡ä¸€å€‹æ ¼å­
        const randomIdx = Math.floor(Math.random() * emptyCells.length);
        const target = emptyCells[randomIdx];
        
        // é¡¯ç¤ºæ­£ç¢ºç­”æ¡ˆ
        gridData[target.idx].user = gridData[target.idx].val.toString();
        gridData[target.idx].hinted = true;
        
        // æ›´æ–°åˆ†æ•¸å’Œæç¤ºæ¬¡æ•¸
        if (!unlimitedHints) {
            hintsRemaining--;
            score = Math.max(0, score - 5); // ä½¿ç”¨æç¤ºæ‰£5åˆ†
        }
        updateScore();
        updateHintButton();
        
        // æª¢æŸ¥æ˜¯å¦ç¾åœ¨æ­£ç¢ºäº†
        if (parseInt(gridData[target.idx].user) === gridData[target.idx].val && !gridData[target.idx].correct) {
            gridData[target.idx].correct = true;
            totalCorrect++;
        }
        
        render();
    }

    function checkAll() {
        let allCorrect = true;
        let newCorrect = 0;
        
        gridData.forEach((d, i) => {
            if (d.type === 'input') {
                let el = document.querySelectorAll('.cell')[i];
                if (parseInt(d.user) === d.val) {
                    el.classList.add('correct');
                    if (!d.correct) {
                        d.correct = true;
                        newCorrect++;
                    }
                } else {
                    el.classList.add('wrong');
                    allCorrect = false;
                    if (d.correct) {
                        d.correct = false;
                    }
                }
            }
        });
        
        // æ›´æ–°åˆ†æ•¸
        if (newCorrect > 0) {
            score += newCorrect * 10;
            totalCorrect += newCorrect;
            updateScore();
        }
        
        if (allCorrect) {
            setTimeout(() => {
                alert(`Excellent! Perfect solution!\nYour score: ${score}\nTime: ${document.getElementById('timer').textContent}`);
                // è‡ªå‹•é€²å…¥ä¸‹ä¸€é¡Œ
                generate();
            }, 200);
        }
    }

    // åˆå§‹åŒ–
    generate();
    updateScore();
    updateHintButton();
    setupTimerClickHandler();
</script>
</body>
</html>