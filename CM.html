<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>CrossMath Puzzle</title>
    <style>
        :root {
            --bg-main: #f8f9fa;
            --primary: #3b82f6;
            --cell-num: #ffffff;
            --cell-op: #e5e7eb;
            --cell-res: #4b5563;
            --text-dark: #1f2937;
            --accent: #10b981;
            --error: #ef4444;
            --grid-gap: 4px;
            --cell-size: min(15vw, 8.5vh);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            font-family: 'Inter', -apple-system, system-ui, sans-serif;
            background-color: var(--bg-main);
            color: var(--text-dark);
            margin: 0;
            height: 100dvh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Top Navigation */
        .nav {
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            min-height: 50px;
            flex-shrink: 0;
        }
        .nav h1 { 
            font-size: 1.2rem;
            margin: 0; 
            font-weight: 800; 
            color: var(--primary); 
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }
        .nav .score { 
            font-size: 0.85rem;
            font-weight: 600; 
            color: #6b7280;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .nav .score span {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }
        .nav .score .control-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 4px 10px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 70px;
            font-weight: 600;
        }
        .nav .score .control-btn.restart {
            background: #6b7280;
        }
        .nav .score .control-btn:active {
            transform: translateY(1px);
            opacity: 0.9;
        }
        .nav .score .control-btn:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }

        /* Enhanced Difficulty Selector - 完全重新設計 */
        .difficulty-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-left: 10px;
            position: relative;
            z-index: 100;
        }
        
        .difficulty-container {
            position: relative;
            min-width: 160px;
        }
        
        .difficulty-display {
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 10px 16px;
            font-size: 0.9rem;
            font-weight: 700;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            color: var(--primary);
            cursor: pointer;
            outline: none;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 44px;
        }
        
        .difficulty-display:hover {
            background: linear-gradient(135deg, #e0f2fe 0%, #dbeafe 100%);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.25);
            transform: translateY(-1px);
        }
        
        .difficulty-display:active {
            transform: translateY(0);
        }
        
        .difficulty-display .arrow {
            font-size: 0.8rem;
            transition: transform 0.3s ease;
            color: var(--primary);
        }
        
        .difficulty-display.open .arrow {
            transform: rotate(180deg);
        }
        
        .difficulty-options {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--primary);
            border-radius: 12px;
            margin-top: 6px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: none;
            overflow: hidden;
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .difficulty-options.show {
            display: block;
            animation: fadeInUp 0.2s ease-out;
        }
        
        .difficulty-option {
            padding: 14px 16px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .difficulty-option:last-child {
            border-bottom: none;
        }
        
        .difficulty-option:hover {
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            color: var(--primary);
            transform: translateX(4px);
        }
        
        .difficulty-option.selected {
            background: linear-gradient(135deg, var(--primary) 0%, #2563eb 100%);
            color: white;
        }
        
        .difficulty-option .difficulty-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
        
        .difficulty-option.beginner .difficulty-indicator { background: #10b981; }
        .difficulty-option.elementary .difficulty-indicator { background: #3b82f6; }
        .difficulty-option.intermediate .difficulty-indicator { background: #f59e0b; }
        .difficulty-option.advanced .difficulty-indicator { background: #ef4444; }
        .difficulty-option.master .difficulty-indicator { background: #8b5cf6; }
        
        .difficulty-option.master {
            font-weight: 800;
        }
        
        /* 隱藏原生的select元素 */
        .difficulty-select {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }

        /* Game Area */
        .game-area {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 5px 10px;
            min-height: 0;
            overflow: hidden;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(7, var(--cell-size));
            grid-template-rows: repeat(7, var(--cell-size));
            gap: var(--grid-gap);
            background: #d1d5db;
            padding: var(--grid-gap);
            border-radius: 12px;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
            transform: scale(1);
        }

        .cell {
            background: var(--cell-num);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            font-weight: 700;
            transition: all 0.15s ease;
        }

        /* Number Input Cells */
        .cell.input {
            color: var(--primary);
            cursor: pointer;
            box-shadow: inset 0 -2px 0 rgba(0,0,0,0.05);
        }
        .cell.input.selected {
            background: var(--primary);
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
            z-index: 2;
        }

        /* Fixed Number Cells */
        .cell.fixed { background: #f3f4f6; color: var(--text-dark); }

        /* Operator and Equals */
        .cell.op, .cell.eq {
            background: var(--cell-op);
            color: #6b7280;
            font-size: 2.4rem !important;
            font-weight: 900;
        }
        
        .cell.op[data-op="÷"], .cell.op[data-op="/"] {
            font-size: 2.6rem !important;
        }
        
        .cell.op[data-op="+"] {
            font-size: 2.5rem !important;
        }

        /* Result Cells */
        .cell.res {
            background: var(--cell-res);
            color: #fff;
            font-size: 1.5rem;
        }

        .cell.empty { background: transparent; }

        /* Status Colors */
        .cell.correct { background: var(--accent) !important; color: white !important; }
        .cell.wrong { background: var(--error) !important; color: white !important; animation: shake 0.4s; }
        .cell.hint { background: #fbbf24 !important; color: white !important; }

        /* Keyboard Area */
        .keyboard {
            background: #fff;
            padding: 8px 6px calc(8px + env(safe-area-inset-bottom));
            border-radius: 16px 16px 0 0;
            box-shadow: 0 -4px 15px rgba(0,0,0,0.05);
            flex-shrink: 0;
            max-height: 28vh;
            margin-bottom: 0;
        }

        .keys-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
            max-width: 460px;
            margin: 0 auto;
        }

        .key {
            background: #f3f4f6;
            border: none;
            padding: 8px 0;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 40px;
        }

        .key:active { background: #e5e7eb; transform: translateY(2px); }
        .key.action { 
            background: var(--primary); 
            color: #fff; 
            grid-column: span 2; 
            font-size: 0.9rem;
            padding: 8px 0;
        }
        .key.del { background: #fee2e2; color: #ef4444; }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20% { transform: translateX(-5px); }
            60% { transform: translateX(5px); }
        }
        
        @keyframes fadeInUp {
            from { 
                opacity: 0; 
                transform: translateY(10px); 
            }
            to { 
                opacity: 1; 
                transform: translateY(0); 
            }
        }
        
        /* Win Screen */
        .win-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
            animation: fadeIn 0.3s ease-out;
        }
        
        .win-screen.show {
            display: flex;
        }
        
        .win-content {
            background: white;
            border-radius: 20px;
            padding: 30px 25px;
            max-width: 400px;
            width: 90%;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease-out;
        }
        
        .win-title {
            font-size: 2.5rem;
            color: #10b981;
            margin-bottom: 15px;
            font-weight: 800;
        }
        
        .win-stats {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 25px;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
        }
        
        .win-stat {
            display: flex;
            justify-content: space-between;
            font-size: 1.1rem;
        }
        
        .win-stat-label {
            color: #6b7280;
        }
        
        .win-stat-value {
            font-weight: 700;
            color: #1f2937;
        }
        
        .win-buttons {
            display: flex;
            justify-content: center;
        }
        
        .win-btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
            background: var(--primary);
            color: white;
        }
        
        .win-btn:active {
            transform: translateY(2px);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px) scale(0.9); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        
        /* Mobile Adaptation - 重新設計的佈局 */
        @media (max-width: 480px) {
            :root {
                --cell-size: min(12.6vw, 6.75vh);
            }
            
            .grid {
                transform: scale(0.9);
            }
            
            .cell {
                font-size: 1.6rem;
            }
            
            .cell.op, .cell.eq {
                font-size: 2.2rem !important;
            }
            
            .cell.op[data-op="÷"], .cell.op[data-op="/"] {
                font-size: 2.4rem !important;
            }
            
            .cell.op[data-op="+"] {
                font-size: 2.3rem !important;
            }
            
            .keyboard {
                padding: 6px 4px calc(6px + env(safe-area-inset-bottom) - 6px);
                margin-bottom: 55px;
            }
            
            .keys-grid {
                gap: 4px;
            }
            
            .key {
                padding: 7px 0;
                min-height: 38px;
                font-size: 0.95rem;
            }
            
            .key.action {
                font-size: 0.85rem;
            }
            
            /* 重新設計的導航欄佈局 - 只在手機版生效 */
            .nav {
                padding: 8px 10px;
                flex-direction: column;
                gap: 8px;
                min-height: auto;
            }
            
            .nav h1 {
                font-size: 1.2rem;
                order: 1;
                width: 100%;
                justify-content: center;
                margin-bottom: 0;
            }
            
            .nav-main-content {
                order: 2;
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: flex-start;
            }
            
            .nav .score {
                order: 1;
                flex-direction: column;
                align-items: flex-start;
                gap: 6px;
                flex: 1;
            }
            
            .nav .score-info {
                display: flex;
                gap: 12px;
                width: 100%;
                justify-content: flex-start;
            }
            
            .nav .score-buttons {
                display: flex;
                gap: 8px;
                width: 100%;
                justify-content: flex-start;
            }
            
            .nav .score .control-btn {
                min-width: 70px;
                padding: 6px 10px;
                font-size: 0.8rem;
            }
            
            .difficulty-selector {
                order: 2;
                margin-left: 0;
                justify-content: flex-end;
                margin-top: 0;
            }
            
            .difficulty-container {
                min-width: 140px;
            }
            
            .difficulty-display {
                padding: 8px 14px;
                font-size: 0.85rem;
                min-height: 40px;
            }
            
            .difficulty-option {
                padding: 12px 14px;
                font-size: 0.85rem;
            }
            
            .win-content {
                padding: 20px 15px;
                width: 95%;
            }
            
            .win-title {
                font-size: 2rem;
            }
            
            .win-stat {
                font-size: 1rem;
            }
        }
        
        /* Landscape Adaptation */
        @media (max-height: 500px) and (orientation: landscape) {
            :root {
                --cell-size: min(9vw, 10.8vh);
            }
            
            .nav {
                min-height: 40px;
                padding: 5px 10px;
            }
            
            .game-area {
                padding: 3px 6px;
            }
            
            .keyboard {
                padding: 5px 4px calc(5px + env(safe-area-inset-bottom) + 40px);
                max-height: 25vh;
                margin-bottom: 40px;
            }
            
            .key {
                min-height: 35px;
                padding: 5px 0;
                font-size: 0.9rem;
            }
            
            /* 橫向模式下保持原始佈局 */
            .nav {
                flex-direction: row;
                justify-content: space-between;
                align-items: center;
            }
            
            .nav h1 {
                order: 0;
                width: auto;
                justify-content: flex-start;
            }
            
            .nav-main-content {
                display: contents;
            }
            
            .nav .score {
                flex-direction: row;
                align-items: center;
                gap: 12px;
            }
            
            .nav .score-info {
                display: contents;
            }
            
            .nav .score-buttons {
                display: contents;
            }
            
            .difficulty-selector {
                margin-left: 10px;
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body>

<div class="nav">
    <h1 id="titleClickArea">CrossMath</h1>
    <div class="difficulty-selector">
        <div class="difficulty-container">
            <div class="difficulty-display" id="difficultyDisplay">
                <span id="currentDifficulty">Elementary</span>
                <span class="arrow">▼</span>
            </div>
            <div class="difficulty-options" id="difficultyOptions">
                <div class="difficulty-option beginner" data-value="beginner">
                    <span class="difficulty-indicator"></span>
                    <span>Beginner</span>
                </div>
                <div class="difficulty-option elementary selected" data-value="elementary">
                    <span class="difficulty-indicator"></span>
                    <span>Elementary</span>
                </div>
                <div class="difficulty-option intermediate" data-value="intermediate">
                    <span class="difficulty-indicator"></span>
                    <span>Intermediate</span>
                </div>
                <div class="difficulty-option advanced" data-value="advanced">
                    <span class="difficulty-indicator"></span>
                    <span>Advanced</span>
                </div>
                <div class="difficulty-option master" data-value="master">
                    <span class="difficulty-indicator"></span>
                    <span>Master</span>
                </div>
            </div>
            <select class="difficulty-select" id="difficultySelect">
                <option value="beginner">Beginner</option>
                <option value="elementary" selected>Elementary</option>
                <option value="intermediate">Intermediate</option>
                <option value="advanced">Advanced</option>
                <option value="master">Master</option>
            </select>
        </div>
    </div>
    <div class="score">
        <span id="timerClickArea">Time: <span id="timer">00:00</span></span>
        <span>Score: <span id="score">0</span></span>
        <button class="control-btn" id="hintBtn" onclick="playHintSound(); useHint()">Hint: 3</button>
        <button class="control-btn restart" onclick="playResetSound(); resetCurrentPuzzle()">Reset</button>
    </div>
</div>

<div class="game-area">
    <div class="grid" id="gameGrid"></div>
</div>

<!-- Win Screen -->
<div class="win-screen" id="winScreen">
    <div class="win-content">
        <div class="win-title">You Win!</div>
        <div class="win-stats">
            <div class="win-stat">
                <span class="win-stat-label">Final Score:</span>
                <span class="win-stat-value" id="winScore">0</span>
            </div>
            <div class="win-stat">
                <span class="win-stat-label">Time:</span>
                <span class="win-stat-value" id="winTime">00:00</span>
            </div>
            <div class="win-stat">
                <span class="win-stat-label">Hints Used:</span>
                <span class="win-stat-value" id="winHints">0</span>
            </div>
            <div class="win-stat">
                <span class="win-stat-label">Difficulty:</span>
                <span class="win-stat-value" id="winDifficulty">Elementary</span>
            </div>
        </div>
        <div class="win-buttons">
            <button class="win-btn" onclick="newGameFromWin()">New Game</button>
        </div>
    </div>
</div>

<div class="keyboard">
    <div class="keys-grid">
        <button class="key" onclick="press(1)">1</button>
        <button class="key" onclick="press(2)">2</button>
        <button class="key" onclick="press(3)">3</button>
        <button class="key" onclick="press(4)">4</button>
        <button class="key" onclick="press(5)">5</button>
        <button class="key" onclick="press(6)">6</button>
        <button class="key" onclick="press(7)">7</button>
        <button class="key" onclick="press(8)">8</button>
        <button class="key" onclick="press(9)">9</button>
        <button class="key" onclick="press(0)">0</button>
        <button class="key del" onclick="press('del')">⌫</button>
        <button class="key action" onclick="playCheckAnswerSound(); checkAll()">Check Answer</button>
        <button class="key action" style="background:#6b7280" onclick="playNewGameSound(); generateNewPuzzle()">New Game</button>
    </div>
</div>

<script>
    let gridData = [];
    let activeIdx = -1;
    let sessionScore = 0;
    let hintsRemaining = 3;
    let startTime = null;
    let timerInterval = null;
    let totalCorrect = 0;
    let totalInputCells = 0;
    let unlimitedHints = false;
    let timerClickCount = 0;
    let timerClickTimeout = null;
    let hintsUsed = 0;
    let titleClickCount = 0;
    let titleClickTimeout = null;
    
    let soundEnabled = true;
    let audioContext = null;
    let isAudioContextInitialized = false;
    
    let currentDifficulty = 'elementary';
    const difficultySettings = {
        'beginner': { name: 'Beginner', fixedCount: 6, hiddenCount: 3, scoreMultiplier: 1.0 },
        'elementary': { name: 'Elementary', fixedCount: 5, hiddenCount: 4, scoreMultiplier: 1.2 },
        'intermediate': { name: 'Intermediate', fixedCount: 4, hiddenCount: 5, scoreMultiplier: 1.5 },
        'advanced': { name: 'Advanced', fixedCount: 3, hiddenCount: 6, scoreMultiplier: 1.8 },
        'master': { name: 'Master', fixedCount: 2, hiddenCount: 7, scoreMultiplier: 2.2 }
    };

    function initAudioContext() {
        if (audioContext && isAudioContextInitialized) return;
        
        try {
            const AudioContextClass = window.AudioContext || window.webkitAudioContext;
            if (AudioContextClass) {
                audioContext = new AudioContextClass();
                
                if (audioContext.state === 'suspended') {
                    audioContext.resume().then(() => {
                        isAudioContextInitialized = true;
                    });
                } else {
                    isAudioContextInitialized = true;
                }
            }
        } catch (e) {
            soundEnabled = false;
        }
    }
    
    // 選擇音效
    function playSelectSound() {
        if (!soundEnabled) return;
        
        try {
            initAudioContext();
            
            if (!audioContext || !isAudioContextInitialized) return;
            
            const now = audioContext.currentTime;
            
            // 選擇音效 - 短脈衝，正弦波
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 392; // G4
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.325, now + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.31);
            
            oscillator.start(now);
            oscillator.stop(now + 0.31);
            
        } catch (e) {
            // 靜默失敗
        }
    }
    
    // 輸入音效
    function playInputSound() {
        if (!soundEnabled) return;
        
        try {
            initAudioContext();
            
            if (!audioContext || !isAudioContextInitialized) return;
            
            const now = audioContext.currentTime;
            
            // 輸入音效 - 更低頻率，方波
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 220; // A3
            oscillator.type = 'square';
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.25, now + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
            
            oscillator.start(now);
            oscillator.stop(now + 0.25);
            
        } catch (e) {
            // 靜默失敗
        }
    }
    
    // New Game音效
    function playNewGameSound() {
        if (!soundEnabled) return;
        
        try {
            initAudioContext();
            
            if (!audioContext || !isAudioContextInitialized) return;
            
            const now = audioContext.currentTime;
            
            // New Game音效 - 單一音調
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 523.25; // C5
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.325, now + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            
            oscillator.start(now);
            oscillator.stop(now + 0.3);
            
        } catch (e) {
            // 靜默失敗
        }
    }
    
    // 重新設計的勝利音樂 - 避免破音，改善音質
    function playWinSound() {
        if (!soundEnabled) return;
        
        try {
            initAudioContext();
            
            if (!audioContext || !isAudioContextInitialized) return;
            
            const now = audioContext.currentTime;
            
            // 使用較低的音量避免破音
            // 簡化旋律，避免過多音頻疊加
            const notes = [
                { freq: 523.25, start: 0.0, duration: 0.3, volume: 0.3 },   // C5
                { freq: 659.25, start: 0.2, duration: 0.3, volume: 0.4 },   // E5
                { freq: 783.99, start: 0.4, duration: 0.4, volume: 0.5 }    // G5
            ];
            
            notes.forEach(note => {
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = note.freq;
                oscillator.type = 'sine'; // 使用正弦波，音色更柔和
                
                // 使用更平滑的淡入淡出曲線
                gainNode.gain.setValueAtTime(0, now + note.start);
                gainNode.gain.linearRampToValueAtTime(note.volume, now + note.start + 0.05);
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + note.start + note.duration);
                
                oscillator.start(now + note.start);
                oscillator.stop(now + note.start + note.duration);
            });
            
            // 簡化低音部分，避免與主旋律衝突
            setTimeout(() => {
                const bassOscillator = audioContext.createOscillator();
                const bassGainNode = audioContext.createGain();
                
                bassOscillator.connect(bassGainNode);
                bassGainNode.connect(audioContext.destination);
                
                bassOscillator.frequency.value = 261.63; // C4
                bassOscillator.type = 'sine';
                
                // 降低低音音量
                bassGainNode.gain.setValueAtTime(0, audioContext.currentTime);
                bassGainNode.gain.linearRampToValueAtTime(0.2, audioContext.currentTime + 0.1);
                bassGainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.6);
                
                bassOscillator.start();
                bassOscillator.stop(audioContext.currentTime + 0.6);
                
            }, 400); // 延遲開始，避免與主旋律重疊
            
        } catch (e) {
            // 靜默失敗
        }
    }
    
    function playResetSound() {
        if (!soundEnabled) return;
        
        try {
            initAudioContext();
            
            if (!audioContext || !isAudioContextInitialized) return;
            
            const now = audioContext.currentTime;
            
            // Reset音效 - 下降音，方形波
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 440; // A4
            oscillator.type = 'square';
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.25, now + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
            
            oscillator.frequency.setValueAtTime(440, now);
            oscillator.frequency.linearRampToValueAtTime(329.63, now + 0.3); // E4
            
            oscillator.start(now);
            oscillator.stop(now + 0.3);
            
        } catch (e) {
            // 靜默失敗
        }
    }
    
    function playHintSound() {
        if (!soundEnabled) return;
        
        try {
            initAudioContext();
            
            if (!audioContext || !isAudioContextInitialized) return;
            
            const now = audioContext.currentTime;
            
            // Hint音效 - 三角波，明亮音色
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 659.25; // E5
            oscillator.type = 'triangle';
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.25, now + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            
            oscillator.frequency.setValueAtTime(659.25, now);
            oscillator.frequency.linearRampToValueAtTime(783.99, now + 0.4); // G5
            
            oscillator.start(now);
            oscillator.stop(now + 0.4);
            
        } catch (e) {
            // 靜默失敗
        }
    }
    
    function playCheckAnswerSound() {
        if (!soundEnabled) return;
        
        try {
            initAudioContext();
            
            if (!audioContext || !isAudioContextInitialized) return;
            
            const now = audioContext.currentTime;
            
            // 檢查答案音效 - 上升音，鋸齒波
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 329.63; // E4
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.25, now + 0.1);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.4);
            
            oscillator.frequency.setValueAtTime(329.63, now);
            oscillator.frequency.linearRampToValueAtTime(440, now + 0.4); // A4
            
            oscillator.start(now);
            oscillator.stop(now + 0.4);
            
        } catch (e) {
            // 靜默失敗
        }
    }
    
    function playErrorSound() {
        if (!soundEnabled) return;
        
        try {
            initAudioContext();
            
            if (!audioContext || !isAudioContextInitialized) return;
            
            const now = audioContext.currentTime;
            
            // 錯誤音效 - 鋸齒波下降音
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 311; // D#4
            oscillator.type = 'sawtooth';
            
            gainNode.gain.setValueAtTime(0, now);
            gainNode.gain.linearRampToValueAtTime(0.25, now + 0.05);
            gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.35);
            
            oscillator.frequency.setValueAtTime(311, now);
            oscillator.frequency.linearRampToValueAtTime(220, now + 0.35); // A3
            
            oscillator.start(now);
            oscillator.stop(now + 0.35);
            
        } catch (e) {
            // 靜默失敗
        }
    }

    function startTimer() {
        if (timerInterval) clearInterval(timerInterval);
        startTime = new Date();
        timerInterval = setInterval(updateTimer, 1000);
    }

    function updateTimer() {
        const now = new Date();
        const diff = Math.floor((now - startTime) / 1000);
        const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
        const seconds = (diff % 60).toString().padStart(2, '0');
        document.getElementById('timer').textContent = `${minutes}:${seconds}`;
    }

    function updateScore() {
        document.getElementById('score').textContent = sessionScore;
    }

    function updateHintButton() {
        const btn = document.getElementById('hintBtn');
        if (unlimitedHints) {
            btn.textContent = `Hint: ∞`;
            btn.disabled = false;
            btn.style.background = '#10b981';
        } else {
            btn.textContent = `Hint: ${hintsRemaining}`;
            btn.disabled = hintsRemaining <= 0;
            btn.style.background = hintsRemaining <= 0 ? '#9ca3af' : 'var(--primary)';
        }
    }

    function setupTimerClickHandler() {
        const timerClickArea = document.getElementById('timerClickArea');
        timerClickArea.style.cursor = 'pointer';
        
        timerClickArea.addEventListener('click', function() {
            timerClickCount++;
            
            if (timerClickTimeout) {
                clearTimeout(timerClickTimeout);
            }
            
            timerClickTimeout = setTimeout(() => {
                timerClickCount = 0;
            }, 2000);
            
            if (timerClickCount === 3) {
                activateUnlimitedHints();
                timerClickCount = 0;
            }
        });
    }
    
    function setupTitleClickHandler() {
        const titleClickArea = document.getElementById('titleClickArea');
        titleClickArea.style.cursor = 'pointer';
        
        titleClickArea.addEventListener('click', function() {
            titleClickCount++;
            
            if (titleClickTimeout) {
                clearTimeout(titleClickTimeout);
            }
            
            titleClickTimeout = setTimeout(() => {
                titleClickCount = 0;
            }, 2000);
            
            if (titleClickCount === 3) {
                showWinScreen();
                titleClickCount = 0;
            }
        });
    }
    
    // 重新設計難度選擇器 - 大氣美觀
    function setupDifficultyHandler() {
        const difficultyDisplay = document.getElementById('difficultyDisplay');
        const difficultyOptions = document.getElementById('difficultyOptions');
        const difficultySelect = document.getElementById('difficultySelect');
        const currentDifficultyElement = document.getElementById('currentDifficulty');
        const optionElements = difficultyOptions.querySelectorAll('.difficulty-option');
        
        // 初始化顯示當前難度
        currentDifficultyElement.textContent = difficultySettings[currentDifficulty].name;
        
        // 切換下拉選單顯示/隱藏
        function toggleDropdown() {
            difficultyDisplay.classList.toggle('open');
            difficultyOptions.classList.toggle('show');
            playSelectSound();
        }
        
        // 點擊顯示/隱藏下拉選單
        difficultyDisplay.addEventListener('click', function(e) {
            e.stopPropagation();
            toggleDropdown();
        });
        
        // 點擊選項
        optionElements.forEach(option => {
            option.addEventListener('click', function() {
                const value = this.getAttribute('data-value');
                const name = this.querySelector('span:not(.difficulty-indicator)').textContent;
                
                // 更新當前顯示
                currentDifficultyElement.textContent = name;
                
                // 更新選中狀態
                optionElements.forEach(opt => opt.classList.remove('selected'));
                this.classList.add('selected');
                
                // 更新原生select
                difficultySelect.value = value;
                
                // 更新當前難度
                currentDifficulty = value;
                
                // 關閉下拉選單
                difficultyDisplay.classList.remove('open');
                difficultyOptions.classList.remove('show');
                
                // 播放選擇音效
                playSelectSound();
                
                // 生成新謎題
                generateNewPuzzle();
            });
        });
        
        // 點擊頁面其他地方關閉下拉選單
        document.addEventListener('click', function(e) {
            if (!difficultyDisplay.contains(e.target) && !difficultyOptions.contains(e.target)) {
                difficultyDisplay.classList.remove('open');
                difficultyOptions.classList.remove('show');
            }
        });
        
        // 原生select變化時也更新自訂顯示（備用）
        difficultySelect.addEventListener('change', function() {
            const value = this.value;
            const name = this.options[this.selectedIndex].text;
            currentDifficultyElement.textContent = name;
            
            // 更新自訂選項選中狀態
            optionElements.forEach(opt => {
                opt.classList.remove('selected');
                if (opt.getAttribute('data-value') === value) {
                    opt.classList.add('selected');
                }
            });
            
            currentDifficulty = value;
            generateNewPuzzle();
        });
    }
    
    function activateUnlimitedHints() {
        unlimitedHints = true;
        hintsRemaining = 999;
        updateHintButton();
    }

    function resetCurrentPuzzle() {
        const winScreen = document.getElementById('winScreen');
        winScreen.classList.remove('show');
        
        // 重置計時器
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
        startTime = null;
        
        // 重置所有輸入單元格
        gridData.forEach((cell, index) => {
            if (cell.type === 'input') {
                cell.user = '';
                cell.correct = false;
                cell.hinted = false;
            }
        });
        
        // 重置提示次數（如果沒有無限提示）
        if (!unlimitedHints) {
            hintsRemaining = 3;
        }
        hintsUsed = 0;
        totalCorrect = 0;
        
        // 重置當前選中的單元格
        activeIdx = -1;
        
        // 更新界面
        updateHintButton();
        document.getElementById('timer').textContent = '00:00';
        
        // 重新開始計時
        startTimer();
        
        // 重新渲染
        render();
    }

    function generateNewPuzzle() {
        const winScreen = document.getElementById('winScreen');
        winScreen.classList.remove('show');
        
        if (!unlimitedHints) {
            hintsRemaining = 3;
        }
        hintsUsed = 0;
        
        updateHintButton();
        generate();
    }

    function newGameFromWin() {
        const winScreen = document.getElementById('winScreen');
        winScreen.classList.remove('show');
        generateNewPuzzle();
    }

    function solve(a, op1, b, op2, c) {
        a = parseInt(a);
        b = parseInt(b);
        c = parseInt(c);
        
        let result;
        
        if (op1 === '*' || op1 === '/') {
            if (op1 === '*') {
                result = a * b;
            } else {
                if (b === 0) return null;
                if (a % b !== 0) return null;
                result = a / b;
            }
            
            if (op2 === '+') {
                result = result + c;
            } else if (op2 === '-') {
                result = result - c;
            } else if (op2 === '*') {
                result = result * c;
            } else {
                if (c === 0) return null;
                if (result % c !== 0) return null;
                result = result / c;
            }
        } else if (op2 === '*' || op2 === '/') {
            let temp;
            if (op2 === '*') {
                temp = b * c;
            } else {
                if (c === 0) return null;
                if (b % c !== 0) return null;
                temp = b / c;
            }
            
            if (op1 === '+') {
                result = a + temp;
            } else {
                result = a - temp;
            }
        } else {
            if (op1 === '+') {
                result = a + b;
            } else {
                result = a - b;
            }
            
            if (op2 === '+') {
                result = result + c;
            } else {
                result = result - c;
            }
        }
        
        return result;
    }

    function generate() {
        const grid = document.getElementById('gameGrid');
        grid.innerHTML = '';
        gridData = Array(49).fill({type: 'empty'});
        totalCorrect = 0;
        totalInputCells = 0;
        
        let attempts = 0;
        let foundValidPuzzle = false;
        
        while (attempts < 10000 && !foundValidPuzzle) {
            attempts++;
            let temp = {};
            
            [0,2,4,14,16,18,28,30,32].forEach(i => temp[i] = Math.floor(Math.random()*12)+1);
            
            [1,3,15,17,29,31,7,21,9,23,11,25].forEach(i => {
                const ops = ['+', '-', '*', '/'];
                const randomNum = Math.random();
                if (randomNum < 0.7) {
                    temp[i] = ops[Math.floor(Math.random()*3)];
                } else {
                    temp[i] = ops[Math.floor(Math.random()*4)];
                }
            });

            let r0 = solve(temp[0], temp[1], temp[2], temp[3], temp[4]);
            let r2 = solve(temp[14], temp[15], temp[16], temp[17], temp[18]);
            let r4 = solve(temp[28], temp[29], temp[30], temp[31], temp[32]);
            
            let c0 = solve(temp[0], temp[7], temp[14], temp[21], temp[28]);
            let c2 = solve(temp[2], temp[9], temp[16], temp[23], temp[30]);
            let c4 = solve(temp[4], temp[11], temp[18], temp[25], temp[32]);

            let all = [r0, r2, r4, c0, c2, c4];
            
            if (all.every(v => v !== null && 
                              Number.isInteger(v) && 
                              v >= 0 && 
                              v <= 50 && 
                              v < 100)) {
                foundValidPuzzle = true;
                
                const numIdx = [0,2,4,14,16,18,28,30,32];
                const fixedCount = difficultySettings[currentDifficulty].fixedCount;
                
                const shuffledIndices = [...numIdx].sort(() => Math.random() - 0.5);
                const fixedIndices = shuffledIndices.slice(0, fixedCount);
                
                numIdx.forEach(idx => {
                    let isFixed = fixedIndices.includes(idx);
                    gridData[idx] = { 
                        type: isFixed ? 'fixed' : 'input', 
                        val: temp[idx], 
                        user: '',
                        correct: false,
                        hinted: false
                    };
                    if (!isFixed) totalInputCells++;
                });
                
                [1,3,15,17,29,31,7,21,9,23,11,25].forEach(idx => {
                    gridData[idx] = { type: 'op', val: temp[idx] };
                });
                
                [5,19,33,35,37,39].forEach(idx => gridData[idx] = { type: 'eq', val: '=' });
                
                [6,20,34].forEach((idx, i) => gridData[idx] = { type: 'res', val: [r0, r2, r4][i] });
                [42,44,46].forEach((idx, i) => gridData[idx] = { type: 'res', val: [c0, c2, c4][i] });
            }
        }
        
        if (!foundValidPuzzle) {
            const defaultPuzzle = {
                numbers: {0: 3, 2: 5, 4: 2, 14: 4, 16: 1, 18: 7, 28: 2, 30: 3, 32: 5},
                ops: {1: '+', 3: '-', 15: '+', 17: '*', 29: '-', 31: '+', 7: '-', 21: '+', 9: '*', 23: '-', 11: '+', 25: '-'}
            };
            
            const r0 = solve(defaultPuzzle.numbers[0], defaultPuzzle.ops[1], defaultPuzzle.numbers[2], defaultPuzzle.ops[3], defaultPuzzle.numbers[4]);
            const r2 = solve(defaultPuzzle.numbers[14], defaultPuzzle.ops[15], defaultPuzzle.numbers[16], defaultPuzzle.ops[17], defaultPuzzle.numbers[18]);
            const r4 = solve(defaultPuzzle.numbers[28], defaultPuzzle.ops[29], defaultPuzzle.numbers[30], defaultPuzzle.ops[31], defaultPuzzle.numbers[32]);
            const c0 = solve(defaultPuzzle.numbers[0], defaultPuzzle.ops[7], defaultPuzzle.numbers[14], defaultPuzzle.ops[21], defaultPuzzle.numbers[28]);
            const c2 = solve(defaultPuzzle.numbers[2], defaultPuzzle.ops[9], defaultPuzzle.numbers[16], defaultPuzzle.ops[23], defaultPuzzle.numbers[30]);
            const c4 = solve(defaultPuzzle.numbers[4], defaultPuzzle.ops[11], defaultPuzzle.numbers[18], defaultPuzzle.ops[25], defaultPuzzle.numbers[32]);
            
            const numIdx = [0,2,4,14,16,18,28,30,32];
            const fixedCount = difficultySettings[currentDifficulty].fixedCount;
            
            const shuffledIndices = [...numIdx].sort(() => Math.random() - 0.5);
            const fixedIndices = shuffledIndices.slice(0, fixedCount);
            
            numIdx.forEach(idx => {
                let isFixed = fixedIndices.includes(idx);
                gridData[idx] = { 
                    type: isFixed ? 'fixed' : 'input', 
                    val: defaultPuzzle.numbers[idx], 
                    user: '',
                    correct: false,
                    hinted: false
                };
                if (!isFixed) totalInputCells++;
            });
            
            Object.keys(defaultPuzzle.ops).forEach(idx => {
                gridData[parseInt(idx)] = { type: 'op', val: defaultPuzzle.ops[idx] };
            });
            
            [5,19,33,35,37,39].forEach(idx => gridData[idx] = { type: 'eq', val: '=' });
            [6,20,34].forEach((idx, i) => gridData[idx] = { type: 'res', val: [r0, r2, r4][i] });
            [42,44,46].forEach((idx, i) => gridData[idx] = { type: 'res', val: [c0, c2, c4][i] });
        }
        
        startTimer();
        render();
    }

    function render() {
        const container = document.getElementById('gameGrid');
        container.innerHTML = '';
        gridData.forEach((d, i) => {
            let el = document.createElement('div');
            el.className = `cell ${d.type}`;
            
            if (d.hinted) {
                el.classList.add('hint');
            }
            
            if (i === activeIdx) {
                el.classList.add('selected');
            }
            
            if (d.type === 'input') {
                el.innerText = d.user;
                // 確保選擇空格有音效
                el.onclick = () => {
                    document.querySelectorAll('.cell').forEach(c => c.classList.remove('selected'));
                    el.classList.add('selected');
                    activeIdx = i;
                    
                    playSelectSound(); // 播放選擇音效
                };
            } else if (d.type !== 'empty') {
                const displayValue = d.val === '*' ? '×' : d.val === '/' ? '÷' : d.val;
                el.innerText = displayValue;
                
                if (d.type === 'op') {
                    el.setAttribute('data-op', displayValue);
                }
            }
            container.appendChild(el);
        });
    }

    function press(v) {
        if (activeIdx === -1) return;
        let cell = gridData[activeIdx];
        
        if (v === 'del') {
            cell.user = '';
            playSelectSound(); // 刪除使用選擇音效
        } else if (cell.user.length < 2) {
            cell.user += v;
            playInputSound(); // 輸入數字使用輸入音效
        }
        
        render();
        
        const inputCells = gridData.filter((d,idx) => d.type==='input' && idx<=activeIdx);
        if (inputCells.length > 0) {
            const index = inputCells.length - 1;
            document.querySelectorAll('.cell.input')[index].click();
        }
    }

    function useHint() {
        if (!unlimitedHints && hintsRemaining <= 0) return;
        
        const emptyCells = gridData
            .map((cell, idx) => ({cell, idx}))
            .filter(item => item.cell.type === 'input' && !item.cell.hinted);
        
        if (emptyCells.length === 0) return;
        
        const randomIdx = Math.floor(Math.random() * emptyCells.length);
        const target = emptyCells[randomIdx];
        
        gridData[target.idx].user = gridData[target.idx].val.toString();
        gridData[target.idx].hinted = true;
        
        if (!unlimitedHints) {
            hintsRemaining--;
        }
        hintsUsed++;
        
        updateHintButton();
        
        render();
    }

    function checkAll() {
        let allCorrect = true;
        let correctCells = 0;
        let hasError = false;
        
        gridData.forEach((d, i) => {
            if (d.type === 'input') {
                if (parseInt(d.user) === d.val) {
                    correctCells++;
                } else {
                    allCorrect = false;
                    hasError = true;
                }
            }
        });
        
        gridData.forEach((d, i) => {
            if (d.type === 'input') {
                let el = document.querySelectorAll('.cell')[i];
                if (parseInt(d.user) === d.val) {
                    el.classList.add('correct');
                } else {
                    el.classList.add('wrong');
                }
            }
        });
        
        if (hasError) {
            playErrorSound();
        }
        
        if (allCorrect) {
            let baseScore = correctCells * 10;
            const timeBonus = calculateTimeBonus();
            const hintPenalty = hintsUsed * 5;
            const difficultyMultiplier = difficultySettings[currentDifficulty].scoreMultiplier;
            
            const currentPuzzleScore = Math.max(0, Math.floor((baseScore + timeBonus - hintPenalty) * difficultyMultiplier));
            
            sessionScore += currentPuzzleScore;
            updateScore();
            
            setTimeout(() => {
                showWinScreen(currentPuzzleScore);
            }, 500);
        }
    }
    
    function calculateTimeBonus() {
        const now = new Date();
        const diff = Math.floor((now - startTime) / 1000);
        
        if (diff <= 30) return 50;
        if (diff <= 60) return 30;
        if (diff <= 90) return 20;
        if (diff <= 120) return 10;
        return 0;
    }
    
    function showWinScreen(currentPuzzleScore = 0) {
        const winScreen = document.getElementById('winScreen');
        const winScore = document.getElementById('winScore');
        const winTime = document.getElementById('winTime');
        const winHints = document.getElementById('winHints');
        const winDifficulty = document.getElementById('winDifficulty');
        
        winScore.textContent = currentPuzzleScore;
        winTime.textContent = document.getElementById('timer').textContent;
        winHints.textContent = hintsUsed;
        winDifficulty.textContent = difficultySettings[currentDifficulty].name;
        
        winScreen.classList.add('show');
        
        playWinSound();
    }

    function initGame() {
        generate();
        updateScore();
        updateHintButton();
        setupTimerClickHandler();
        setupTitleClickHandler();
        setupDifficultyHandler();
        
        initAudioContext();
    }

    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initGame);
    } else {
        initGame();
    }
    
    document.addEventListener('click', function() {
        initAudioContext();
    }, { once: true });
</script>
</body>
</html>